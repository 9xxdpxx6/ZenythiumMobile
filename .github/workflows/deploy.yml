name: Deploy zenythium.ru (frontend)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: deploy-zenythium-ru
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Optional: create Environment "production" in GitHub and store secrets/vars there.
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies (rsync, ssh)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        # Ensure devDependencies are installed (vite/vue-tsc live in devDependencies).
        env:
          NODE_ENV: development
          NPM_CONFIG_PRODUCTION: "false"
        run: npm ci --include=dev

      - name: Build
        env:
          NODE_ENV: production
          # IMPORTANT: Vite reads VITE_* at build time (vite build).
          # API is hosted separately on api.zenythium.ru (Variant A).
          VITE_API_SERVER_URL: https://api.zenythium.ru
          # Optional overrides (defaults in code are /api and /v1)
          VITE_API_PREFIX: /api
          VITE_API_VERSION: /v1
          # Optional, if used in prod:
          VITE_YANDEX_CAPTCHA_SITE_KEY: ${{ secrets.VITE_YANDEX_CAPTCHA_SITE_KEY }}
        run: npm run build

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add server to known_hosts
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          # Optional (recommended): pinned known_hosts entry to avoid MITM.
          # Example value line (one or more lines):
          # zenythium.ru ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI...
          DEPLOY_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
        shell: bash
        run: |
          set -euo pipefail
          : "${DEPLOY_HOST:?Missing DEPLOY_HOST secret}"
          DEPLOY_PORT="${DEPLOY_PORT:-22}"
          mkdir -p ~/.ssh
          if [ -n "${DEPLOY_KNOWN_HOSTS:-}" ]; then
            printf "%s\n" "$DEPLOY_KNOWN_HOSTS" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -p "$DEPLOY_PORT" -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi

      - name: Deploy dist/ via rsync
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          # Path on the SERVER (host filesystem) that your nginx serves for zenythium.ru.
          # Example: /srv/zenythium/frontend/zenythium.ru
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        shell: bash
        run: |
          set -euo pipefail
          : "${DEPLOY_HOST:?Missing DEPLOY_HOST secret}"
          : "${DEPLOY_USER:?Missing DEPLOY_USER secret}"
          : "${DEPLOY_PATH:?Missing DEPLOY_PATH secret}"
          DEPLOY_PORT="${DEPLOY_PORT:-22}"

          if ! command -v rsync >/dev/null 2>&1; then
            echo "Local rsync is missing (runner)."
            exit 1
          fi

          REMOTE="${DEPLOY_USER}@${DEPLOY_HOST}"
          SSH="ssh -p ${DEPLOY_PORT}"

          # Safety: never allow deploying into filesystem root
          if [ "${DEPLOY_PATH%/}" = "/" ]; then
            echo "DEPLOY_PATH must not be '/'."
            exit 1
          fi

          # Ensure target dir exists
          $SSH "$REMOTE" "mkdir -p '${DEPLOY_PATH%/}'"
          
          # Fast fail with a clear message if remote path is not writable
          if ! $SSH "$REMOTE" "test -w '${DEPLOY_PATH%/}'"; then
            echo "Remote DEPLOY_PATH is not writable by ${DEPLOY_USER}."
            echo "Fix permissions on the server (chown/chmod/ACL) or change DEPLOY_PATH."
            $SSH "$REMOTE" "ls -ld '${DEPLOY_PATH%/}' || true"
            exit 1
          fi

          # rsync requires rsync binary on BOTH sides. If remote doesn't have it, fallback to tar over ssh.
          if $SSH "$REMOTE" "command -v rsync >/dev/null 2>&1"; then
            rsync -az --delete \
              --no-times --omit-dir-times \
              --exclude='.well-known/acme-challenge/**' \
              -e "ssh -p ${DEPLOY_PORT}" \
              dist/ \
              "${REMOTE}:${DEPLOY_PATH%/}/"
          else
            echo "Remote rsync is missing; falling back to tar-over-ssh deployment."
            # Preserve ACME challenge folder if it's stored under site root
            $SSH "$REMOTE" "mkdir -p -- '${DEPLOY_PATH%/}/.well-known/acme-challenge'"
            $SSH "$REMOTE" "find '${DEPLOY_PATH%/}' -mindepth 1 -maxdepth 1 ! -name '.well-known' -exec rm -rf -- {} +"
            $SSH "$REMOTE" "find '${DEPLOY_PATH%/}/.well-known' -mindepth 1 -maxdepth 1 ! -name 'acme-challenge' -exec rm -rf -- {} +"
            tar -C dist -czf - . | $SSH "$REMOTE" "tar -xzf - -C '${DEPLOY_PATH%/}'"
          fi

      - name: Post-deploy command (optional)
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          DEPLOY_POST_DEPLOY_CMD: ${{ secrets.DEPLOY_POST_DEPLOY_CMD }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_POST_DEPLOY_CMD:-}" ]; then
            echo "DEPLOY_POST_DEPLOY_CMD is empty; skipping post-deploy step."
            exit 0
          fi
          DEPLOY_PORT="${DEPLOY_PORT:-22}"
          ssh -p "$DEPLOY_PORT" "${DEPLOY_USER}@${DEPLOY_HOST}" "${DEPLOY_POST_DEPLOY_CMD}"


